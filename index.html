<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCUS - Task Board</title>
    
    <!-- Modern SVG App Icon (Data URI for reliability on Desktop & Mobile) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f97316;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23db2777;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='128' fill='url(%23grad)'/%3E%3Cpath d='M368 176L214.3 336 144 263' stroke='white' stroke-width='48' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f97316;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23db2777;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='128' fill='url(%23grad)'/%3E%3Cpath d='M368 176L214.3 336 144 263' stroke='white' stroke-width='48' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f97316;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23db2777;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='128' fill='url(%23grad)'/%3E%3Cpath d='M368 176L214.3 336 144 263' stroke='white' stroke-width='48' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation (Pinned Version to fix compilation error) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

    <style>
        /* Base styles to prevent flash of unstyled content */
        body { background-color: #000; color: #fff; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Imports from CDN ---
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import confetti from 'https://esm.sh/canvas-confetti@1.6.0';
        
        // Lucide Icons
        import { 
            Check, Trash2, User, Plus, Lock, LogOut, Loader2, Download, X, Monitor, 
            UserPlus, LogIn, ListTodo, CalendarDays, Image as ImageIcon, Upload, 
            GripVertical, ChevronDown, ChevronUp, Paperclip, FolderPlus, Tag, Sticker, 
            Moon, Sun, Palette, Layout, Clock, CheckCircle2, CircleDashed, ArrowRightCircle, 
            Maximize2, RotateCw, ArrowUp, ArrowDown, Smartphone, Calendar, AlertTriangle,
            Edit3, Link as LinkIcon, ExternalLink, Save, Eye, ChevronRight, ArrowRight, ArrowLeft,
            DollarSign, TrendingUp
        } from 'https://esm.sh/lucide-react@0.292.0';

        // Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, doc, getDoc, setDoc, onSnapshot 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Configuration & Initialization ---
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' 
        ? JSON.parse(window.__firebase_config) 
        : {
            apiKey: "AIzaSyBBNqz4gs_wx1XumM3OO1q0RkOEFTgP5OA",
            authDomain: "dev-board-task.firebaseapp.com",
            projectId: "dev-board-task",
            storageBucket: "dev-board-task.firebasestorage.app",
            messagingSenderId: "1004609201868",
            appId: "1:1004609201868:web:ad84a8f1c72f15a79fc469",
            measurementId: "G-RVFWRC1BD3"
            };

        const app = initializeApp(firebaseConfig);
        let analytics;
        try {
            analytics = getAnalytics(app);
        } catch (e) {
            console.log("Analytics not supported in this environment");
        }

        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

        // --- Global Styles ---
        const GLOBAL_STYLES = `
        @keyframes apple-spring {
            0% { transform: scale(0.95); opacity: 0; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slide-up-fade {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-spring {
            animation: apple-spring 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        .animate-slide-up {
            animation: slide-up-fade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .btn-press {
            transition: transform 0.1s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .btn-press:active {
            transform: scale(0.96);
        }
        .smooth-scroll {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        textarea.auto-grow {
            field-sizing: content; 
            min-height: 24px;
            resize: none;
            overflow: hidden;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.2);
            border-radius: 10px;
        }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.4);
        }
        `;

        const TEXT = {
            welcome: "Welcome back",
            create_profile: "New Profile",
            sign_in: "Sign In",
            create_account: "Create Account",
            username: "Username",
            pin: "4-Digit PIN",
            username_placeholder: "e.g. alex",
            pin_placeholder: "0000",
            btn_sign_in: "Sign In",
            btn_create_profile: "Create Profile",
            error_fill: "Enter name & PIN",
            error_taken: "Name taken",
            error_pin: "Wrong PIN",
            error_user_not_found: "User not found",
            error_connection: "Connection failed",
            connecting: "Connecting...",
            version: "v1.0",
            task_title: "Task Board",
            task_subtitle: "Organize your workflow",
            task_input_placeholder: "New task...",
            task_add_btn: "Add",
            task_title_placeholder: "Task Title",
            install_app: "Install App",
            install_app_desc: "Add to Home Screen",
            logged_in_as: "User:",
            sign_out: "Log Out",
            add_subtask: "Add subtask...",
            limit_reached: "Max 10 images",
            category_general: "General",
            new_category: "Category Name",
            add_to_category: "Category:",
            add_category_btn: "New Tag",
            status_upcoming: "Upcoming",
            status_today: "Today",
            status_inprogress: "In Progress",
            status_completed: "Completed"
        };

        // --- Hooks & Helpers ---

        const usePWAInjection = () => {
            useEffect(() => {
                // Helper to create a PNG blob from the SVG
                const createPngIcon = (svgDataUri, size) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            canvas.toBlob((blob) => {
                                resolve(URL.createObjectURL(blob));
                            }, 'image/png');
                        };
                        img.src = svgDataUri;
                    });
                };

                const setupPWA = async () => {
                    const iconSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f97316;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23db2777;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='128' fill='url(%23grad)'/%3E%3Cpath d='M368 176L214.3 336 144 263' stroke='white' stroke-width='48' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E`;
                    
                    // Create PNG versions for better compatibility (Windows Taskbar/Desktop)
                    const iconPng192 = await createPngIcon(iconSvg, 192);
                    const iconPng512 = await createPngIcon(iconSvg, 512);

                    const updateLink = (rel, href) => {
                        let link = document.querySelector(`link[rel="${rel}"]`);
                        if (!link) {
                            link = document.createElement('link');
                            link.rel = rel;
                            document.head.appendChild(link);
                        }
                        link.href = href;
                    };

                    updateLink('icon', iconSvg);
                    updateLink('shortcut icon', iconSvg);
                    updateLink('apple-touch-icon', iconSvg);

                    const manifest = {
                        "name": "FOCUS",
                        "short_name": "FOCUS",
                        "start_url": ".",
                        "display": "standalone",
                        "background_color": "#000000",
                        "theme_color": "#000000",
                        "icons": [
                            { 
                                "src": iconSvg, 
                                "sizes": "any", 
                                "type": "image/svg+xml",
                                "purpose": "any" 
                            },
                            {
                                "src": iconPng192,
                                "sizes": "192x192",
                                "type": "image/png",
                                "purpose": "any"
                            },
                            {
                                "src": iconPng512,
                                "sizes": "512x512",
                                "type": "image/png",
                                "purpose": "any"
                            }
                        ]
                    };
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(blob);
                    updateLink('manifest', manifestURL);
                };

                setupPWA();
            }, []);
        };

        const useMobileDetect = () => {
            const [isMobile, setIsMobile] = useState(false);
            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth < 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);
            return isMobile;
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const getLocalISODate = (offsetDays = 0) => {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Format Currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount || 0);
        };

        const hexToRgb = (hex) => {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 0, g: 0, b: 0 };
        };

        const QUICK_COLORS = ['#f97316', '#ef4444', '#f43f5e', '#d946ef', '#8b5cf6', '#3b82f6', '#06b6d4', '#10b981', '#eab308', '#ffffff'];

        const getThemeStyles = (isDarkMode, accentColor) => {
            const rgb = hexToRgb(accentColor);
            const bgBase = isDarkMode ? '#000000' : '#f2f2f7'; 
            const cardBase = isDarkMode ? '#1C1C1E' : '#ffffff'; 
            const columnBase = isDarkMode ? '#000000' : '#f2f2f7';
            const textMain = isDarkMode ? '#ffffff' : '#000000';
            const textSec = isDarkMode ? '#8E8E93' : '#8E8E93';
            const border = isDarkMode ? '#2C2C2E' : '#E5E5EA';
            const accent = accentColor;
            
            return { 
                isDark: isDarkMode, 
                accent: accent, 
                appContainer: { backgroundColor: bgBase, color: textMain }, 
                card: { backgroundColor: cardBase, borderColor: border, borderWidth: '1px' }, 
                column: { backgroundColor: columnBase, borderColor: border }, 
                header: { 
                    borderColor: border, 
                    backgroundColor: isDarkMode ? 'rgba(28, 28, 30, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                    backdropFilter: 'blur(20px)'
                }, 
                textMain: { color: textMain }, 
                textSec: { color: textSec }, 
                textAccent: { color: accent }, 
                buttonPrimary: { backgroundColor: accent, color: isDarkMode ? '#000' : '#fff' }, 
                buttonGhost: { color: textSec }, 
                input: { 
                    backgroundColor: isDarkMode ? '#2C2C2E' : '#E5E5EA', 
                    borderColor: 'transparent', 
                    color: textMain, 
                    placeholderColor: textSec
                },
                modalOverlay: { backgroundColor: 'rgba(0, 0, 0, 0.6)' }
            };
        };

        const INITIAL_TASKS = []; 

        // --- Sub-Components ---

        const EditableText = ({ text, onUpdate, className, placeholder, style, isDoubleClick, onClick, readOnly }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [localText, setLocalText] = useState(text);
            const inputRef = useRef(null);
            
            useEffect(() => { setLocalText(text); }, [text]);
            useEffect(() => { 
                if (isEditing && inputRef.current) { 
                    inputRef.current.focus(); 
                    inputRef.current.style.height = 'auto'; 
                    inputRef.current.style.height = inputRef.current.scrollHeight + 'px'; 
                } 
            }, [isEditing]);

            const handleBlur = () => { setIsEditing(false); if (localText !== text) { onUpdate(localText); } };
            const handleActivate = (e) => { if(readOnly) return; e.stopPropagation(); setIsEditing(true); }
            const handleSingleClick = (e) => { if (onClick) onClick(e); }

            if (isEditing && !readOnly) { 
                return ( 
                    <textarea 
                        ref={inputRef} 
                        value={localText} 
                        onChange={(e) => { setLocalText(e.target.value); e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }} 
                        onBlur={handleBlur} 
                        onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleBlur(); } }} 
                        className={`w-full bg-transparent outline-none resize-none overflow-hidden ${className}`} 
                        placeholder={placeholder} 
                        rows={1} 
                        style={style} 
                        onClick={(e) => e.stopPropagation()} 
                    /> 
                ); 
            }
            return ( 
                <div 
                    onClick={isDoubleClick ? handleSingleClick : handleActivate} 
                    onDoubleClick={isDoubleClick && !readOnly ? handleActivate : undefined} 
                    className={`min-h-[1.5em] ${readOnly ? '' : 'cursor-text'} ${className}`} 
                    style={style} 
                > 
                    {localText || <span className="opacity-50">{placeholder}</span>} 
                </div> 
            );
        };

        const ImagePreviewModal = ({ src, isOpen, onClose }) => { 
            if (!isOpen || !src) return null; 
            return ( 
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in" onClick={onClose}> 
                    <div className="relative max-w-full max-h-full"> 
                        <img src={src} alt="Preview" className="rounded-2xl shadow-2xl max-w-full max-h-[85vh] object-contain animate-spring" onClick={(e) => e.stopPropagation()}/> 
                        <button className="absolute -top-12 right-0 p-2 text-white bg-white/10 rounded-full" onClick={onClose}><X className="w-6 h-6" /></button> 
                    </div> 
                </div> 
            ); 
        };

        const InstallModal = ({ isOpen, onClose, theme, text }) => { 
            if (!isOpen) return null; 
            return ( 
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 backdrop-blur-md transition-opacity duration-300"> 
                    <div className={`border rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-spring m-4`} style={theme.card}> 
                        <div className={`p-4 border-b flex justify-between items-center backdrop-blur-md bg-opacity-90`} style={theme.header}> 
                            <h3 className={`font-bold flex items-center gap-2`} style={theme.textMain}><Download className="w-5 h-5" style={{ color: theme.accent }} /> {text.install_app}</h3> 
                            <button onClick={onClose} className={`p-2 rounded-full btn-press hover:opacity-70`} style={theme.textSec}><X className="w-5 h-5" /></button> 
                        </div> 
                        <div className="p-6 space-y-6"> 
                            <p className={`text-sm mb-4`} style={theme.textSec}>{text.install_app_desc}</p> 
                            <div className="flex gap-4 items-start"><div className="bg-blue-100 p-3 rounded-xl text-blue-600 flex-shrink-0 shadow-sm"><Monitor className="w-6 h-6" /></div><div><h4 className={`font-bold text-sm`} style={theme.textMain}>Mac & Windows</h4><p className={`text-xs mt-1`} style={theme.textSec}>Look for the Install icon in the address bar.</p></div></div> 
                            <div className="flex gap-4 items-start"><div className={`p-3 rounded-xl flex-shrink-0 shadow-sm border`} style={{ ...theme.card, ...theme.textMain }}><Smartphone className="w-6 h-6" /></div><div><h4 className={`font-bold text-sm`} style={theme.textMain}>iPhone (Safari)</h4><p className={`text-xs mt-1`} style={theme.textSec}>Tap Share â†’ Add to Home Screen.</p></div></div> 
                        </div> 
                        <div className={`p-4 border-t text-center`} style={theme.header}><button onClick={onClose} className={`text-sm font-bold hover:opacity-80 btn-press px-4 py-2 rounded-lg`} style={theme.textSec}>Close</button></div> 
                    </div> 
                </div> 
            ) 
        };

        const RevenueModal = ({ isOpen, onClose, theme, revenueHistory }) => {
            if (!isOpen) return null;
            
            const totalLifetime = revenueHistory.reduce((acc, curr) => acc + curr.amount, 0);

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm transition-opacity duration-300" onClick={onClose}>
                    <div className="w-full max-w-md rounded-[2rem] p-6 shadow-2xl animate-spring" style={theme.card} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-black flex items-center gap-2" style={theme.textMain}>
                                <div className="p-2 rounded-xl bg-green-500/10 text-green-500"><TrendingUp className="w-5 h-5" /></div>
                                Revenue
                            </h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-black/5" style={{ color: theme.textSec.color }}><X className="w-5 h-5" /></button>
                        </div>

                        <div className="mb-8 text-center p-6 rounded-3xl border bg-gradient-to-br from-green-500/10 to-transparent" style={{ borderColor: theme.card.borderColor }}>
                            <span className="text-xs font-bold uppercase tracking-widest opacity-60" style={theme.textSec}>Lifetime Earnings</span>
                            <div className="text-4xl font-black mt-2 text-green-500">{formatCurrency(totalLifetime)}</div>
                        </div>

                        <div className="space-y-3 max-h-[40vh] overflow-y-auto custom-scrollbar pr-2">
                            <h4 className="text-xs font-bold uppercase opacity-50 mb-4" style={theme.textSec}>Monthly Breakdown</h4>
                            {revenueHistory.length === 0 ? (
                                <div className="text-center py-8 opacity-40 text-sm italic">No completed tasks with revenue yet.</div>
                            ) : (
                                revenueHistory.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center p-4 rounded-2xl border transition-all hover:bg-black/5" style={{ backgroundColor: theme.appContainer.backgroundColor, borderColor: theme.card.borderColor }}>
                                        <div className="font-bold text-sm" style={theme.textMain}>{item.month}</div>
                                        <div className="font-mono font-bold text-green-500">{formatCurrency(item.amount)}</div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Task Modal Component (View/Edit Modes) ---
        const TaskModal = ({ task, onClose, onUpdate, onDelete, theme }) => {
            const [mode, setMode] = useState('view'); // 'view' | 'edit'
            const [tempCategoryName, setTempCategoryName] = useState('');
            const [isAddingNewCategory, setIsAddingNewCategory] = useState(false);
            const [newSubtaskCategory, setNewSubtaskCategory] = useState('General');
            const [deleteConfirmation, setDeleteConfirmation] = useState(false);
            
            // UI State for collapse
            const [collapsedSections, setCollapsedSections] = useState({});

            // Link State
            const [newLinkUrl, setNewLinkUrl] = useState('');
            const [newLinkTitle, setNewLinkTitle] = useState('');
            const [newLinkCategory, setNewLinkCategory] = useState('General');
            const [isAddingLink, setIsAddingLink] = useState(false);

            // Helpers
            const toggleTag = (tagName) => {
                const currentTags = task.categories || ['General'];
                let newTags;
                if (currentTags.includes(tagName)) {
                    if(tagName === 'General' && currentTags.length === 1) return; // Cannot delete last tag if it's general
                    newTags = currentTags.filter(t => t !== tagName);
                } else {
                    newTags = [...currentTags, tagName];
                }
                onUpdate({ categories: newTags });
            };

            const toggleSection = (sectionKey) => {
                const currentCollapsed = task.collapsedTags || [];
                const newCollapsed = currentCollapsed.includes(sectionKey) 
                    ? currentCollapsed.filter(k => k !== sectionKey)
                    : [...currentCollapsed, sectionKey];
                onUpdate({ collapsedTags: newCollapsed });
            };

            const addLink = () => {
                if (!newLinkUrl.trim()) return;
                const linkObj = {
                    id: generateId(),
                    url: newLinkUrl.trim().startsWith('http') ? newLinkUrl.trim() : `https://${newLinkUrl.trim()}`,
                    title: newLinkTitle.trim() || newLinkUrl.trim(),
                    category: newLinkCategory
                };
                
                // Add category if not exists
                const currentCats = task.categories || ['General'];
                const newCats = currentCats.includes(newLinkCategory) ? currentCats : [...currentCats, newLinkCategory];

                onUpdate({ 
                    categories: newCats,
                    links: [...(task.links || []), linkObj] 
                });
                setNewLinkUrl('');
                setNewLinkTitle('');
                setIsAddingLink(false);
            };

            const deleteLink = (linkId) => {
                onUpdate({ links: (task.links || []).filter(l => l.id !== linkId) });
            };

            const handleClose = () => {
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in" style={theme.modalOverlay} onClick={handleClose}>
                    <div className="w-full max-w-lg rounded-[2.5rem] shadow-2xl animate-spring flex flex-col max-h-[85vh] overflow-hidden" style={theme.card} onClick={(e) => e.stopPropagation()}>
                        
                        {/* --- Header --- */}
                        <div className="p-6 border-b flex flex-col gap-4 transition-all" style={{ borderColor: theme.card.borderColor, backgroundColor: theme.header.backgroundColor }}>
                            <div className="flex justify-between items-start">
                                <div className="flex-1 mr-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className={`px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider border`} style={{ borderColor: theme.card.borderColor, color: theme.textSec.color }}>{task.status}</div>
                                        {/* Priority Selector */}
                                        {mode === 'edit' ? (
                                            <div className="flex gap-1 p-1 rounded-lg border bg-opacity-10" style={{ borderColor: theme.card.borderColor }}>
                                                {['Low', 'Medium', 'High'].map(p => (
                                                    <button key={p} onClick={() => { onUpdate({ priority: p }); }} className={`px-2 py-0.5 text-[10px] font-bold uppercase rounded-md transition-all ${task.priority === p ? 'shadow-sm text-white' : 'opacity-50'}`} style={task.priority === p ? { backgroundColor: p === 'High' ? '#ef4444' : p === 'Medium' ? '#f97316' : '#3b82f6' } : { color: theme.textSec.color }}>{p}</button>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className={`px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider border ${task.priority === 'High' ? 'bg-red-500/10 text-red-500 border-red-500/20' : task.priority === 'Medium' ? 'bg-orange-500/10 text-orange-500 border-orange-500/20' : 'bg-blue-500/10 text-blue-500 border-blue-500/20'}`}>
                                                {task.priority}
                                            </div>
                                        )}
                                    </div>
                                    <EditableText 
                                        text={task.text} 
                                        onUpdate={(txt) => onUpdate({ text: txt })} 
                                        className="text-2xl font-bold leading-tight" 
                                        style={theme.textMain} 
                                        readOnly={mode === 'view'}
                                        placeholder="Task Title" 
                                    />
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => { setMode(mode === 'view' ? 'edit' : 'view'); }} className={`p-2 rounded-full transition-colors ${mode === 'edit' ? 'bg-green-500 text-white shadow-lg' : 'hover:bg-black/5'}`} style={mode === 'view' ? { color: theme.textSec.color } : {}}>
                                        {mode === 'view' ? <Edit3 className="w-5 h-5" /> : <Save className="w-5 h-5" />}
                                    </button>
                                    <button onClick={handleClose} className="p-2 rounded-full hover:bg-black/5 transition-colors" style={{ color: theme.textSec.color }}><X className="w-6 h-6" /></button>
                                </div>
                            </div>

                            {/* Revenue Input */}
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-sm font-medium flex-1" style={theme.textSec}>
                                    <div className="p-1.5 rounded-lg bg-green-500/10 text-green-500"><DollarSign className="w-4 h-4" /></div>
                                    {mode === 'edit' ? (
                                        <input 
                                            type="number" 
                                            placeholder="Revenue (e.g. 500)"
                                            value={task.revenue || ''} 
                                            onChange={(e) => onUpdate({ revenue: parseFloat(e.target.value) || 0 })} 
                                            className="bg-transparent outline-none w-full" 
                                            style={{ color: theme.textMain.color }} 
                                        />
                                    ) : (
                                        <span className={task.revenue ? "font-bold text-green-500" : "opacity-50"}>
                                            {task.revenue ? formatCurrency(task.revenue) : 'No Revenue Set'}
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Deadline */}
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-sm font-medium flex-1" style={theme.textSec}>
                                    <div className="p-1.5 rounded-lg bg-blue-500/10 text-blue-500"><Calendar className="w-4 h-4" /></div>
                                    {mode === 'edit' ? (
                                        <input type="date" value={task.deadline || ''} onChange={(e) => onUpdate({ deadline: e.target.value })} className="bg-transparent outline-none cursor-pointer w-full" style={{ color: theme.textMain.color }} />
                                    ) : (
                                        <span style={{ color: theme.textMain.color }}>{task.deadline ? new Date(task.deadline).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }) : 'No Deadline'}</span>
                                    )}
                                </div>
                                {mode === 'edit' && (
                                    <div className="flex gap-2">
                                        <button onClick={() => { onUpdate({ deadline: getLocalISODate(0) }); }} className="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wide bg-opacity-10 hover:bg-opacity-20 transition-all border" style={{ backgroundColor: theme.accent, borderColor: 'transparent', color: theme.textMain.color }}>Today</button>
                                        <button onClick={() => { onUpdate({ deadline: getLocalISODate(1) }); }} className="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wide transition-all border hover:opacity-80" style={{ borderColor: theme.card.borderColor, color: theme.textSec.color }}>Tom.</button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* --- Body --- */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                            
                            {/* 1. Tags Section */}
                            <div className="space-y-3">
                                <h5 className="text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-2" style={theme.textSec}><Tag className="w-3 h-3" /> Tags</h5>
                                <div className="flex flex-wrap gap-2">
                                    {(task.categories || ['General']).map(cat => (
                                        <div key={cat} className="group flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold transition-all border-2 shadow-sm" style={{ backgroundColor: theme.input.backgroundColor, borderColor: theme.card.borderColor, color: theme.textMain.color }}>
                                            {cat}
                                            {mode === 'edit' && cat !== 'General' && (
                                                <button onClick={() => toggleTag(cat)} className="hover:text-red-500 ml-1"><X className="w-3 h-3" /></button>
                                            )}
                                        </div>
                                    ))}
                                    
                                    {/* Edit Mode: Add New Only (No Cloud) */}
                                    {mode === 'edit' && (
                                        <>
                                            {/* Create New Tag */}
                                            {isAddingNewCategory ? (
                                                <div className="flex items-center gap-1 px-3 py-1.5 rounded-xl border-2 animate-slide-up" style={{ borderColor: theme.accent }}>
                                                    <input autoFocus className="bg-transparent outline-none text-sm font-bold w-24" style={{ color: theme.textMain.color }} placeholder="Name..." value={tempCategoryName} onChange={(e) => setTempCategoryName(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && tempCategoryName.trim()) { toggleTag(tempCategoryName.trim()); setIsAddingNewCategory(false); setTempCategoryName(''); } }} />
                                                    <button onClick={() => { if(tempCategoryName.trim()) { toggleTag(tempCategoryName.trim()); setIsAddingNewCategory(false); setTempCategoryName(''); }}}><Check className="w-4 h-4 text-green-500" /></button>
                                                </div>
                                            ) : (
                                                <button onClick={() => { setIsAddingNewCategory(true); }} className="px-4 py-2 rounded-xl text-sm font-bold border-2 border-dashed hover:opacity-100 opacity-60 transition-all flex items-center gap-1" style={{ borderColor: theme.textSec.color, color: theme.textSec.color }}><Plus className="w-4 h-4" /> New</button>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* 2. Subtasks Section */}
                            <div className="space-y-4">
                                <h5 className="text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-2" style={theme.textSec}><ListTodo className="w-3 h-3" /> Subtasks</h5>
                                
                                {(task.categories || ['General']).map(cat => {
                                    const subItems = (task.subtasks || []).filter(s => (s.category || 'General') === cat);
                                    if (subItems.length === 0 && cat === 'General') return null;
                                    const isCollapsed = (task.collapsedTags || []).includes(`subtasks-${cat}`);

                                    return (
                                        <div key={cat} className="animate-slide-up">
                                            <button 
                                                onClick={() => toggleSection(`subtasks-${cat}`)}
                                                className="w-full flex items-center justify-between mb-2 group"
                                            >
                                                <div className="flex items-center gap-2">
                                                    <h6 className="text-[11px] font-bold uppercase opacity-60" style={theme.textSec}>{cat}</h6>
                                                    <div className="h-[1px] w-full bg-current opacity-10 flex-1"></div>
                                                    <span className="text-[10px] opacity-40 font-mono">({subItems.length})</span>
                                                </div>
                                                <div className={`transform transition-transform ${isCollapsed ? '-rotate-90' : 'rotate-0'}`}>
                                                    <ChevronDown className="w-4 h-4 opacity-40 group-hover:opacity-100" />
                                                </div>
                                            </button>
                                            
                                            {!isCollapsed && (
                                                <div className="space-y-2">
                                                    {subItems.map(subtask => (
                                                        <div key={subtask.id} className="group p-3 rounded-2xl border transition-all hover:shadow-sm animate-fade-in" style={{ borderColor: theme.card.borderColor, backgroundColor: theme.appContainer.backgroundColor }}>
                                                            <div className="flex items-start gap-3">
                                                                <button 
                                                                    onClick={() => {
                                                                        onUpdate({ 
                                                                            subtasks: task.subtasks.map(s => s.id === subtask.id ? { ...s, completed: !s.completed } : s)
                                                                        });
                                                                    }} 
                                                                    className={`mt-0.5 w-5 h-5 rounded-md border-2 flex-shrink-0 flex items-center justify-center transition-all ${subtask.completed ? 'border-transparent' : 'border-gray-300'}`} 
                                                                    style={subtask.completed ? { backgroundColor: theme.accent } : { borderColor: theme.isDark ? '#444' : '#ddd' }}
                                                                >
                                                                    {subtask.completed && <Check className="w-3.5 h-3.5 text-black" strokeWidth={3} />}
                                                                </button>
                                                                <div className="flex-1 min-w-0">
                                                                    <EditableText 
                                                                        text={subtask.text} 
                                                                        onUpdate={(txt) => onUpdate({ subtasks: task.subtasks.map(s => s.id === subtask.id ? { ...s, text: txt } : s) })} 
                                                                        className={`text-sm transition-all ${subtask.completed ? 'line-through opacity-50' : ''}`} 
                                                                        style={theme.textMain}
                                                                        readOnly={mode === 'view'} 
                                                                    />
                                                                </div>
                                                                {mode === 'edit' && (
                                                                    <div className="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        <button onClick={() => { onUpdate({ subtasks: task.subtasks.filter(s => s.id !== subtask.id) }); }} className="p-1.5 hover:bg-red-500/10 rounded-lg text-red-500"><Trash2 className="w-4 h-4" /></button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}

                                {mode === 'edit' && (
                                    <div className="relative pt-2">
                                        <div className="absolute left-3 top-5"><Plus className="w-4 h-4 opacity-50" style={theme.textSec} /></div>
                                        <input 
                                            placeholder="Add new step..." 
                                            className="w-full pl-9 pr-4 py-3 rounded-2xl outline-none text-sm font-medium transition-all focus:ring-2 focus:ring-opacity-50"
                                            style={{ ...theme.input, focusRingColor: theme.accent }}
                                            onKeyDown={(e) => { 
                                                if(e.key === 'Enter' && e.target.value.trim()){ 
                                                    const newSub = { id: generateId(), text: e.target.value.trim(), completed: false, category: newSubtaskCategory };
                                                    // Add category to task if not exists
                                                    const currentCats = task.categories || ['General'];
                                                    const newCats = currentCats.includes(newSubtaskCategory) ? currentCats : [...currentCats, newSubtaskCategory];
                                                    onUpdate({ 
                                                        categories: newCats,
                                                        subtasks: [...(task.subtasks || []), newSub] 
                                                    });
                                                    e.target.value = ''; 
                                                }
                                            }}
                                        />
                                        <div className="flex justify-end mt-2">
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] uppercase font-bold" style={theme.textSec}>Add to:</span>
                                                <select 
                                                    value={newSubtaskCategory} 
                                                    onChange={(e) => setNewSubtaskCategory(e.target.value)}
                                                    className="bg-transparent text-xs font-bold outline-none cursor-pointer"
                                                    style={{ color: theme.accent }}
                                                >
                                                    {(task.categories || ['General']).map(c => (
                                                        <option 
                                                            key={c} 
                                                            value={c} 
                                                            style={{ backgroundColor: theme.card.backgroundColor, color: theme.textMain.color }}
                                                        >
                                                            {c}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* 3. Links Section (With Categories) */}
                            <div className="space-y-4">
                                <h5 className="text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-2" style={theme.textSec}><LinkIcon className="w-3 h-3" /> Links</h5>
                                
                                {(task.categories || ['General']).map(cat => {
                                    const catLinks = (task.links || []).filter(l => (l.category || 'General') === cat);
                                    if (catLinks.length === 0) return null;
                                    const isCollapsed = (task.collapsedTags || []).includes(`links-${cat}`);

                                    return (
                                        <div key={cat} className="animate-slide-up">
                                            <button 
                                                onClick={() => toggleSection(`links-${cat}`)}
                                                className="w-full flex items-center justify-between mb-2 group"
                                            >
                                                <div className="flex items-center gap-2">
                                                    <h6 className="text-[11px] font-bold uppercase opacity-60" style={theme.textSec}>{cat}</h6>
                                                    <div className="h-[1px] w-full bg-current opacity-10 flex-1"></div>
                                                    <span className="text-[10px] opacity-40 font-mono">({catLinks.length})</span>
                                                </div>
                                                <div className={`transform transition-transform ${isCollapsed ? '-rotate-90' : 'rotate-0'}`}>
                                                    <ChevronDown className="w-4 h-4 opacity-40 group-hover:opacity-100" />
                                                </div>
                                            </button>

                                            {!isCollapsed && (
                                                <div className="space-y-2">
                                                    {catLinks.map(link => (
                                                        <div key={link.id} className="flex items-center gap-3 p-3 rounded-xl border group hover:shadow-sm transition-all animate-fade-in" style={{ borderColor: theme.card.borderColor, backgroundColor: theme.appContainer.backgroundColor }}>
                                                            <div className="p-2 rounded-full bg-blue-500/10 text-blue-500"><LinkIcon className="w-4 h-4" /></div>
                                                            <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex-1 min-w-0 hover:underline">
                                                                <div className="text-sm font-bold truncate" style={theme.textMain}>{link.title}</div>
                                                                <div className="text-xs truncate opacity-50" style={theme.textSec}>{link.url}</div>
                                                            </a>
                                                            {mode === 'edit' && (
                                                                <button onClick={() => deleteLink(link.id)} className="p-2 text-red-500 hover:bg-red-500/10 rounded-lg"><Trash2 className="w-4 h-4" /></button>
                                                            )}
                                                            {mode === 'view' && (
                                                                <a href={link.url} target="_blank" rel="noopener noreferrer" className="p-2 opacity-50 hover:opacity-100"><ExternalLink className="w-4 h-4" /></a>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )
                                })}

                                {mode === 'edit' && (
                                    isAddingLink ? (
                                        <div className="p-3 rounded-xl border space-y-2 animate-slide-up" style={{ borderColor: theme.accent, backgroundColor: theme.appContainer.backgroundColor }}>
                                            <input className="w-full bg-transparent text-sm font-bold outline-none" placeholder="Link Title (optional)" value={newLinkTitle} onChange={e => setNewLinkTitle(e.target.value)} style={{ color: theme.textMain.color }} />
                                            <div className="flex items-center gap-2">
                                                <input className="flex-1 bg-transparent text-xs outline-none" placeholder="https://..." autoFocus value={newLinkUrl} onChange={e => setNewLinkUrl(e.target.value)} style={{ color: theme.textMain.color }} onKeyDown={e => e.key === 'Enter' && addLink()} />
                                            </div>
                                            <div className="flex justify-end items-center gap-2 mt-1">
                                                <span className="text-[10px] uppercase font-bold" style={theme.textSec}>Add to:</span>
                                                <select 
                                                    value={newLinkCategory} 
                                                    onChange={(e) => setNewLinkCategory(e.target.value)}
                                                    className="bg-transparent text-xs font-bold outline-none cursor-pointer"
                                                    style={{ color: theme.accent }}
                                                >
                                                    {(task.categories || ['General']).map(c => (
                                                        <option 
                                                            key={c} 
                                                            value={c}
                                                            style={{ backgroundColor: theme.card.backgroundColor, color: theme.textMain.color }}
                                                        >
                                                            {c}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="flex items-center gap-2 mt-2">
                                                <button onClick={addLink} className="text-xs font-bold px-3 py-1 bg-green-500 text-white rounded-lg flex-1">Add Link</button>
                                                <button onClick={() => setIsAddingLink(false)} className="text-xs font-bold px-3 py-1 rounded-lg border" style={{ color: theme.textSec.color, borderColor: theme.card.borderColor }}>Cancel</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <button onClick={() => { setIsAddingLink(true); }} className="w-full py-2 border border-dashed rounded-xl text-xs font-bold opacity-50 hover:opacity-100 transition-all flex items-center justify-center gap-2" style={{ borderColor: theme.textSec.color, color: theme.textSec.color }}>
                                            <Plus className="w-3 h-3" /> Add Link
                                        </button>
                                    )
                                )}
                            </div>

                            {/* 4. Description Section (Moved to Bottom) */}
                            <div className="space-y-3">
                                <h5 className="text-[10px] font-bold uppercase tracking-widest opacity-50 flex items-center gap-2" style={theme.textSec}><Edit3 className="w-3 h-3" /> Description</h5>
                                {mode === 'edit' ? (
                                    <textarea 
                                        value={task.description || ''} 
                                        onChange={(e) => onUpdate({ description: e.target.value })} 
                                        className="w-full bg-transparent border rounded-xl p-3 text-sm min-h-[100px] outline-none focus:ring-2 focus:ring-opacity-50 transition-all"
                                        placeholder="Add details..."
                                        style={{ borderColor: theme.card.borderColor, color: theme.textMain.color, ...theme.input, '--tw-ring-color': theme.accent }}
                                    />
                                ) : (
                                    <div className="text-sm whitespace-pre-wrap leading-relaxed" style={theme.textMain}>
                                        {task.description || <span className="opacity-40 italic">No description provided.</span>}
                                    </div>
                                )}
                            </div>

                        </div>

                        {/* --- Footer --- */}
                        <div className="p-4 border-t flex justify-between items-center bg-opacity-50" style={{ borderColor: theme.card.borderColor }}>
                            <span className="text-[10px] font-mono opacity-50" style={theme.textSec}>ID: {task.id}</span>
                            <div className="flex items-center gap-3">
                                {deleteConfirmation ? (
                                    <>
                                        <span className="text-xs font-bold text-red-500 animate-fade-in">Sure?</span>
                                        <button onClick={() => { onDelete(); }} className="px-4 py-2 rounded-xl text-xs font-bold bg-red-500 text-white hover:bg-red-600 transition-colors shadow-lg">Yes</button>
                                        <button onClick={() => { setDeleteConfirmation(false); }} className="px-4 py-2 rounded-xl text-xs font-bold border hover:bg-black/5 transition-colors" style={{ borderColor: theme.card.borderColor, color: theme.textSec.color }}>No</button>
                                    </>
                                ) : (
                                    <button onClick={() => { setDeleteConfirmation(true); }} className="flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold text-red-500 hover:bg-red-500/10 transition-colors">
                                        <Trash2 className="w-4 h-4" /> Delete
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [appUser, setAppUser] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false); 
            const [usernameExists, setUsernameExists] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true); 
            const [accentColor, setAccentColor] = useState('#f97316'); 
            const [activeColId, setActiveColId] = useState('Today');
            
            const [showRevenueModal, setShowRevenueModal] = useState(false);

            const scrollContainerRef = useRef(null);
            
            // Ref for debouncing saves
            const saveTimeoutRef = useRef(null);

            usePWAInjection();
            const isMobile = useMobileDetect();
            const theme = getThemeStyles(isDarkMode, accentColor);
            
            // Data
            const [tasks, setTasks] = useState(INITIAL_TASKS);
            
            // UI State
            const [newTaskText, setNewTaskText] = useState('');
            const [activeModalTaskId, setActiveModalTaskId] = useState(null); 
            const [previewImage, setPreviewImage] = useState(null);
            
            // Dragging
            const [draggedTaskId, setDraggedTaskId] = useState(null);
            
            const [showInstallModal, setShowInstallModal] = useState(false);
            
            const [loginName, setLoginName] = useState('');
            const [loginPin, setLoginPin] = useState('');

            // --- Derived Revenue Data ---
            const { currentMonthRevenue, revenueHistory } = useMemo(() => {
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                let currentTotal = 0;
                const historyMap = {};

                tasks.forEach(t => {
                    if (t.status === 'Completed' && t.revenue) {
                        // Safety check: Use creation date, or fallback to now if missing/invalid
                        let date;
                        try {
                            date = t.createdAt ? new Date(t.createdAt) : new Date();
                            // Check if date is valid
                            if (isNaN(date.getTime())) {
                                date = new Date();
                            }
                        } catch (e) {
                            date = new Date();
                        }

                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        let monthName;
                        try {
                            monthName = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                        } catch (e) {
                            // Fallback if locale fails
                            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                            monthName = `${months[date.getMonth()]} ${date.getFullYear()}`;
                        }

                        if (key === currentMonthKey) {
                            currentTotal += t.revenue;
                        }

                        if (!historyMap[key]) {
                            historyMap[key] = { month: monthName, amount: 0, sortKey: key };
                        }
                        historyMap[key].amount += t.revenue;
                    }
                });

                const history = Object.values(historyMap).sort((a, b) => b.sortKey.localeCompare(a.sortKey));

                return { currentMonthRevenue: currentTotal, revenueHistory: history };
            }, [tasks]);


            // --- Auth & Data Loading ---
            useEffect(() => { 
                const initAuth = async () => { 
                    try { 
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) { 
                            try { await signInWithCustomToken(auth, window.__initial_auth_token); } 
                            catch (e) { await signInAnonymously(auth); }
                        } else { 
                            await signInAnonymously(auth); 
                        } 
                    } catch (err) { console.error("Auth failed", err); } 
                }; 
                initAuth(); 
                const unsubscribe = onAuthStateChanged(auth, (user) => { setFirebaseUser(user); }); 
                return () => unsubscribe(); 
            }, []);

            useEffect(() => { 
                const checkAutoLogin = async () => { 
                    const savedCreds = localStorage.getItem('focus_user_creds'); 
                    if (!savedCreds) { setLoading(false); return; } 
                    try { 
                        const { username, pin } = JSON.parse(savedCreds); 
                        setAppUser({ username, pin });
                        const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'habit_tracker_users', username); 
                        const docSnap = await getDoc(userDocRef); 
                        if (!docSnap.exists() || docSnap.data().pin !== pin) { 
                            localStorage.removeItem('focus_user_creds'); 
                            setAppUser(null);
                        }
                    } catch (e) { console.error("Auto login failed", e); } 
                    finally { setLoading(false); } 
                }; 
                if (firebaseUser) { checkAutoLogin(); } 
            }, [firebaseUser]);

            useEffect(() => { 
                if (!firebaseUser || !appUser) return; 
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'habit_tracker_users', appUser.username); 
                const unsubscribeSnapshot = onSnapshot(userDocRef, (docSnap) => { 
                    if (docSnap.exists()) { 
                        if (docSnap.metadata.hasPendingWrites) return;

                        const data = docSnap.data(); 
                        if (data.pin === appUser.pin) { 
                            if (data.tasks) setTasks(data.tasks); 
                            if (data.isDarkMode !== undefined) setIsDarkMode(data.isDarkMode); 
                            if (data.accentColor) setAccentColor(data.accentColor); 
                        } 
                    } 
                }, (error) => { console.error("Sync error:", error); }); 
                return () => unsubscribeSnapshot(); 
            }, [firebaseUser, appUser]);

            useEffect(() => { 
                if (!loginName) { setUsernameExists(false); return; } 
                const timer = setTimeout(async () => { 
                    try { 
                        const formattedName = loginName.toLowerCase().replace(/\s+/g, '_'); 
                        const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'habit_tracker_users', formattedName); 
                        const docSnap = await getDoc(userDocRef); 
                        setUsernameExists(docSnap.exists()); 
                    } catch (err) { setUsernameExists(false); } 
                }, 500); 
                return () => clearTimeout(timer); 
            }, [loginName]);

            // --- Mobile Navigation Scroll Listener ---
            useEffect(() => {
                const handleScroll = () => {
                    if (!scrollContainerRef.current) return;
                    const scrollLeft = scrollContainerRef.current.scrollLeft;
                    const width = scrollContainerRef.current.offsetWidth;
                    // Calculate index based on scroll position (assuming mostly full width items)
                    const colIndex = Math.round(scrollLeft / (width * 0.85)); // 0.85 because w-[85vw]
                    
                    if (COLUMNS[colIndex]) {
                        setActiveColId(COLUMNS[colIndex].id);
                    }
                };
                
                const container = scrollContainerRef.current;
                if (container) {
                    container.addEventListener('scroll', handleScroll);
                }
                return () => container && container.removeEventListener('scroll', handleScroll);
            }, []);

            const scrollToColumn = (index) => {
                if (!scrollContainerRef.current) return;
                const container = scrollContainerRef.current;
                const child = container.children[index];
                if (child) {
                    const left = child.offsetLeft - (container.offsetWidth - child.offsetWidth) / 2;
                    container.scrollTo({ left, behavior: 'smooth' });
                }
            };
            
            // --- Logic ---
            
            const saveToFirestore = (updatedTasks, extraData = {}) => {
                if (!appUser || !firebaseUser) return;
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'habit_tracker_users', appUser.username);
                // Save immediately without timeout
                setDoc(userDocRef, { 
                    pin: appUser.pin, 
                    tasks: updatedTasks, 
                    isDarkMode: isDarkMode, 
                    accentColor: accentColor, 
                    lastUpdated: new Date().toISOString(),
                    ...extraData
                }, { merge: true }).catch(err => console.error("Save error:", err));
            };

            // Used for text inputs to prevent hammering DB
            const saveToFirestoreDebounced = (updatedTasks) => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                saveTimeoutRef.current = setTimeout(() => {
                    saveToFirestore(updatedTasks);
                }, 1000);
            };

            const handleAuthAction = async (e) => { 
                e.preventDefault(); 
                if (!loginName.trim() || loginPin.length !== 4) { setAuthError(TEXT.error_fill); return; } 
                setLoading(true); setAuthError(''); 
                const username = loginName.toLowerCase().replace(/\s+/g, '_'); 
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'habit_tracker_users', username); 
                try { 
                    const docSnap = await getDoc(userDocRef); 
                    if (isRegistering) { 
                        if (docSnap.exists()) { setAuthError(TEXT.error_taken); setLoading(false); return; } 
                        await setDoc(userDocRef, { pin: loginPin, tasks: INITIAL_TASKS, isDarkMode: true, accentColor: '#f97316', createdAt: new Date().toISOString() }); 
                        localStorage.setItem('focus_user_creds', JSON.stringify({ username, pin: loginPin })); 
                        setAppUser({ username, pin: loginPin }); 
                    } else { 
                        if (docSnap.exists()) { 
                            if (docSnap.data().pin === loginPin) { 
                                localStorage.setItem('focus_user_creds', JSON.stringify({ username, pin: loginPin })); 
                                setAppUser({ username, pin: loginPin }); 
                            } else { 
                                setAuthError(TEXT.error_pin); setLoading(false); return; } 
                        } else { 
                            setAuthError(TEXT.error_user_not_found); setLoading(false); return; } 
                    } 
                } catch (err) { setAuthError(TEXT.error_connection); } 
                setLoading(false); 
            };

            const handleLogout = () => { localStorage.removeItem('focus_user_creds'); setAppUser(null); setTasks(INITIAL_TASKS); setLoginName(''); setLoginPin(''); setIsRegistering(false); setIsDarkMode(true); };
            
            const moveTaskStatus = (taskId, currentStatus, direction) => {
                const statusOrder = ['Upcoming', 'Today', 'In Progress', 'Completed'];
                const currentIndex = statusOrder.indexOf(currentStatus || 'Today');
                const nextIndex = currentIndex + direction;
                
                if (nextIndex >= 0 && nextIndex < statusOrder.length) {
                    const nextStatus = statusOrder[nextIndex];
                    setTasks(prev => {
                        const newTasks = prev.map(t => t.id === taskId ? { ...t, status: nextStatus } : t);
                        saveToFirestore(newTasks); // Instant Save
                        return newTasks;
                    });
                    
                    if (nextStatus === 'Completed') {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }
            };

            const addTask = (e) => { 
                e.preventDefault(); 
                if (!newTaskText.trim()) return; 
                const newTask = { id: generateId(), text: newTaskText, status: 'Today', priority: 'Medium', createdAt: new Date().toISOString(), subtasks: [], categories: ['General'], deadline: '', revenue: 0 }; 
                setTasks(prev => {
                    const newTasks = [newTask, ...prev];
                    saveToFirestore(newTasks); // Instant Save
                    return newTasks;
                }); 
                setNewTaskText(''); 
            };
            
            // General updater for modal
            const updateTaskGeneric = (taskId, updates) => {
                setTasks(prev => {
                    const newTasks = prev.map(t => t.id === taskId ? { ...t, ...updates } : t);
                    
                    // If updating text fields, debounce. Else save instantly.
                    if (updates.text !== undefined || updates.description !== undefined || updates.revenue !== undefined) {
                        saveToFirestoreDebounced(newTasks);
                    } else {
                        saveToFirestore(newTasks);
                    }
                    return newTasks;
                });
            };

            const updateTaskStatus = (id, newStatus) => { 
                setTasks(prev => {
                    const newTasks = prev.map(t => t.id === id ? { ...t, status: newStatus } : t);
                    saveToFirestore(newTasks);
                    return newTasks;
                }); 
            };

            const updateTaskPriority = (id, newPriority) => { 
                updateTaskGeneric(id, { priority: newPriority }); // Will trigger instant save inside generic
            };

            const updateTaskText = (taskId, newText) => { 
                updateTaskGeneric(taskId, { text: newText }); // Will trigger debounced save
            };

            const updateTaskDeadline = (taskId, date) => { 
                updateTaskGeneric(taskId, { deadline: date }); // Instant save
            };

            const deleteTask = (id) => { 
                setTasks(prev => {
                    const newTasks = prev.filter(t => t.id !== id);
                    saveToFirestore(newTasks); // Instant save
                    return newTasks;
                });
                setActiveModalTaskId(null); 
            };
            
            const handleDragStart = (e, taskId) => { setDraggedTaskId(taskId); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; };
            const handleDrop = (e, status) => { 
                e.preventDefault(); 
                if (draggedTaskId) { 
                    updateTaskStatus(draggedTaskId, status); 
                    setDraggedTaskId(null); 
                } 
            };

            const getPriorityWeight = (p) => {
                switch(p) {
                    case 'High': return 3;
                    case 'Medium': return 2;
                    case 'Low': return 1;
                    default: return 0;
                }
            };

            const COLUMNS = [
                { id: 'Upcoming', title: TEXT.status_upcoming, icon: CalendarDays, color: 'text-blue-500', bg: 'bg-blue-500' },
                { id: 'Today', title: TEXT.status_today, icon: Clock, color: 'text-yellow-500', bg: 'bg-yellow-500' },
                { id: 'In Progress', title: TEXT.status_inprogress, icon: CircleDashed, color: 'text-orange-500', bg: 'bg-orange-500' },
                { id: 'Completed', title: TEXT.status_completed, icon: CheckCircle2, color: 'text-green-500', bg: 'bg-green-500' },
            ];

            const activeTask = tasks.find(t => t.id === activeModalTaskId);
            
            // --- RENDER ---
            if (loading) { return ( <div className={`min-h-[100dvh] flex flex-col items-center justify-center`} style={theme.appContainer}> <style>{GLOBAL_STYLES}</style> <Loader2 className="w-10 h-10 animate-spin mb-4" style={{ color: theme.accent }}/> <p className={`font-medium`} style={theme.textSec}>{TEXT.connecting}</p> </div> ); }

            if (!appUser) {
            return (
                <div className={`min-h-[100dvh] flex items-center justify-center p-4 transition-colors duration-500`} style={{ backgroundColor: theme.appContainer.backgroundColor }}>
                <style>{GLOBAL_STYLES}</style>
                <div className={`p-8 rounded-[2rem] shadow-2xl w-full max-w-md border animate-spring relative`} style={theme.card}>
                    <div className="text-center mb-8"><h1 className="text-5xl font-black tracking-tighter mb-2" style={theme.textMain}>FOCUS</h1><p className={`text-sm`} style={theme.textSec}>{isRegistering ? TEXT.create_profile : TEXT.welcome}</p></div>
                    <div className={`flex p-1 rounded-2xl mb-8`} style={theme.input}><button onClick={() => { setIsRegistering(false); setAuthError(''); }} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all btn-press ${!isRegistering ? 'shadow-md' : 'opacity-60'}`} style={!isRegistering ? { backgroundColor: theme.card.backgroundColor, color: theme.textMain.color } : { color: theme.textSec.color }}>{TEXT.sign_in}</button><button onClick={() => { setIsRegistering(true); setAuthError(''); }} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all btn-press ${isRegistering ? 'shadow-md' : 'opacity-60'}`} style={isRegistering ? { backgroundColor: theme.card.backgroundColor, color: theme.textMain.color } : { color: theme.textSec.color }}>{TEXT.create_account}</button></div>
                    <form onSubmit={handleAuthAction} className="space-y-4">
                    <div className="animate-slide-up" style={{ animationDelay: '0.1s' }}><label className={`block text-xs font-bold uppercase mb-2 ml-1`} style={theme.textSec}>{TEXT.username}</label><div className="relative"><User className="absolute left-4 top-3.5 w-5 h-5" style={theme.textSec} /><input type="text" value={loginName} onChange={(e) => setLoginName(e.target.value)} placeholder={TEXT.username_placeholder} className={`w-full pl-12 pr-4 py-3.5 rounded-2xl outline-none transition-all font-medium`} style={theme.input} autoFocus /></div></div>
                    <div className="animate-slide-up" style={{ animationDelay: '0.2s' }}><label className={`block text-xs font-bold uppercase mb-2 ml-1`} style={theme.textSec}>{TEXT.pin}</label><div className="relative"><Lock className="absolute left-4 top-3.5 w-5 h-5" style={theme.textSec} /><input type="password" value={loginPin} onChange={(e) => { const val = e.target.value.replace(/\D/g, '').slice(0, 4); setLoginPin(val); }} placeholder={TEXT.pin_placeholder} className={`w-full pl-12 pr-4 py-3.5 rounded-2xl outline-none transition-all font-bold tracking-widest`} style={theme.input} /></div></div>
                    {authError && (<div className="p-4 bg-red-500/10 text-red-500 text-sm rounded-2xl flex items-center gap-2 animate-spring font-bold"><div className="w-2 h-2 rounded-full bg-red-500" />{authError}</div>)}
                    <button type="submit" className={`w-full font-bold py-4 rounded-2xl hover:opacity-90 btn-press transition-all shadow-lg mt-4 flex items-center justify-center gap-2 animate-slide-up`} style={theme.buttonPrimary}>{isRegistering ? <><UserPlus className="w-5 h-5"/> {TEXT.btn_create_profile}</> : <><LogIn className="w-5 h-5"/> {TEXT.btn_sign_in}</>}</button>
                    </form>
                </div>
                </div>
            );
            }

            return (
            <div className={`h-[100dvh] w-full font-sans flex flex-col transition-colors duration-300 ease-in-out relative overflow-hidden`} style={theme.appContainer}>
                <style>{GLOBAL_STYLES}</style>
                <InstallModal isOpen={showInstallModal} onClose={() => setShowInstallModal(false)} theme={theme} text={TEXT} />
                <ImagePreviewModal src={previewImage} isOpen={!!previewImage} onClose={() => setPreviewImage(null)} />
                <RevenueModal 
                    isOpen={showRevenueModal} 
                    onClose={() => setShowRevenueModal(false)} 
                    theme={theme}
                    revenueHistory={revenueHistory}
                />
                
                {/* --- Task Detail Modal (Center Screen) --- */}
                {activeModalTaskId && activeTask && (
                    <TaskModal 
                        key={activeTask.id}
                        task={activeTask}
                        onClose={() => setActiveModalTaskId(null)}
                        onUpdate={(updates) => updateTaskGeneric(activeTask.id, updates)}
                        onDelete={() => deleteTask(activeTask.id)}
                        theme={theme}
                    />
                )}

                {/* Header */}
                <div className={`w-full flex-shrink-0 z-20 transition-colors duration-300 border-b`} style={theme.header}>
                    <div className={`w-full max-w-[1600px] mx-auto p-4 flex justify-between items-center`}>
                    <div className="flex items-center gap-2">
                        <h1 className="text-xl md:text-2xl font-black tracking-tighter flex items-center gap-2" style={theme.textMain}>
                            <Layout className="w-6 h-6 md:w-8 md:h-8" style={{ color: theme.accent }}/> 
                            FOCUS
                        </h1>
                    </div>
                    
                    <div className="flex items-center gap-2 md:gap-3">
                        {/* Revenue Island */}
                        <button onClick={() => setShowRevenueModal(true)} className="hidden md:flex items-center gap-2 px-4 py-2 rounded-xl border hover:bg-black/5 transition-all group" style={{ borderColor: theme.card.borderColor }}>
                            <div className="p-1 rounded-full bg-green-500/10 text-green-500 group-hover:scale-110 transition-transform"><DollarSign className="w-4 h-4" /></div>
                            <div className="flex flex-col items-start leading-none">
                                <span className="text-[10px] font-bold uppercase opacity-50" style={theme.textSec}>This Month</span>
                                <span className="text-sm font-black" style={theme.textMain}>{formatCurrency(currentMonthRevenue)}</span>
                            </div>
                        </button>

                        <button onClick={() => { setIsDarkMode(!isDarkMode); }} className="p-2 rounded-xl border hover:bg-black/5 transition-all" style={{ borderColor: theme.card.borderColor, color: theme.textSec.color }}>
                            {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                        </button>
                        <div className="relative group hidden md:block">
                            <button className="p-2 rounded-xl border hover:bg-black/5 transition-all" style={{ borderColor: theme.card.borderColor, color: theme.accent }}>
                                <Palette className="w-5 h-5" />
                            </button>
                            <div className="absolute right-0 top-full mt-2 bg-white dark:bg-neutral-900 border p-2 rounded-2xl shadow-xl grid grid-cols-5 gap-1.5 w-48 z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                                {QUICK_COLORS.map(c => (
                                    <button key={c} onClick={() => { setAccentColor(c); }} className="w-8 h-8 rounded-full border shadow-sm hover:scale-110 transition-transform" style={{ backgroundColor: c, borderColor: theme.card.borderColor }} />
                                ))}
                            </div>
                        </div>
                        <div className="w-[1px] h-6 bg-gray-500/20 mx-1" />
                        <button onClick={() => { handleLogout(); }} className="p-2 rounded-xl hover:bg-red-500/10 text-red-500 transition-all" title={TEXT.sign_out}>
                            <LogOut className="w-5 h-5" />
                        </button>
                    </div>
                    </div>
                </div>

                {/* Main Board Area */}
                <div className={`flex-1 w-full max-w-[1600px] mx-auto p-4 md:p-6 overflow-hidden flex flex-col`}>
                    {/* Mobile: Horizontal Scroll Snap
                        Desktop: Grid Layout (Full width, no horizontal scroll)
                    */}
                    <div ref={scrollContainerRef} className={`flex-1 w-full flex md:grid md:grid-cols-4 gap-4 md:gap-6 overflow-x-auto md:overflow-visible snap-x snap-mandatory pb-4 min-h-0`}>
                        {COLUMNS.map(col => {
                            const colTasks = tasks.filter(t => (t.status || 'Today') === col.id).sort((a,b) => getPriorityWeight(b.priority) - getPriorityWeight(a.priority));
                            const Icon = col.icon;
                            
                            return (
                                <div 
                                    key={col.id} 
                                    className={`snap-center w-[85vw] flex-shrink-0 md:w-auto h-full flex flex-col rounded-[2rem] border shadow-sm backdrop-blur-md transition-colors duration-300 min-h-0`} 
                                    style={theme.column}
                                    onDragOver={handleDragOver}
                                    onDrop={(e) => handleDrop(e, col.id)}
                                >
                                    {/* Column Header */}
                                    <div className={`p-5 flex items-center justify-between flex-shrink-0`}>
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-xl ${col.bg} bg-opacity-15`}>
                                                <Icon className={`w-5 h-5 ${col.color}`} />
                                            </div>
                                            <h3 className={`font-bold text-lg`} style={theme.textMain}>{col.title}</h3>
                                            <span className={`text-xs font-bold px-2.5 py-1 rounded-lg opacity-50`} style={{ backgroundColor: theme.input.backgroundColor, color: theme.textMain.color }}>{colTasks.length}</span>
                                        </div>
                                        {col.id === 'Today' && (
                                            <button onClick={() => { if(newTaskText.trim()) { addTask({ preventDefault: () => {} }); } }} className="p-2 rounded-full hover:bg-black/5 transition-colors" title="Quick Add"><Plus className="w-5 h-5" style={theme.textSec} /></button>
                                        )}
                                    </div>

                                    {/* Quick Add (Today Only) */}
                                    {col.id === 'Today' && (
                                        <div className={`px-4 pb-4 flex-shrink-0`}>
                                            <form onSubmit={addTask} className="relative group">
                                                <input 
                                                    value={newTaskText} 
                                                    onChange={(e) => setNewTaskText(e.target.value)} 
                                                    placeholder="Add new task..." 
                                                    className={`w-full pl-4 pr-10 py-3 rounded-2xl text-sm outline-none border-2 focus:border-opacity-50 transition-all font-medium`}
                                                    style={{ backgroundColor: theme.card.backgroundColor, borderColor: theme.isDark ? '#333' : '#eee', color: theme.textMain.color, focusBorderColor: theme.accent }} 
                                                />
                                                <button type="submit" className={`absolute right-3 top-3 transition-colors ${newTaskText.trim() ? 'text-green-500' : 'text-gray-400'}`}><ArrowRightCircle className="w-5 h-5" /></button>
                                            </form>
                                        </div>
                                    )}

                                    {/* Task List */}
                                    <div className="flex-1 overflow-y-auto px-4 pb-24 md:pb-4 space-y-3 custom-scrollbar min-h-0">
                                            {colTasks.map((task, index) => {
                                                const subtaskCount = task.subtasks ? task.subtasks.length : 0;
                                                const subtaskCompleted = task.subtasks ? task.subtasks.filter(st => st.completed).length : 0;
                                                const progress = subtaskCount > 0 ? (subtaskCompleted / subtaskCount) * 100 : 0;
                                                const isOverdue = task.deadline && new Date(task.deadline) < new Date(new Date().setHours(0,0,0,0));

                                                return (
                                                    <div 
                                                        key={task.id}
                                                        draggable="true"
                                                        onDragStart={(e) => handleDragStart(e, task.id)}
                                                        className={`rounded-2xl p-4 shadow-sm border relative transition-all cursor-grab active:cursor-grabbing animate-slide-up group hover:shadow-md hover:scale-[1.01]`}
                                                        style={{ backgroundColor: theme.card.backgroundColor, borderColor: theme.card.borderColor, animationDelay: `${index * 0.05}s` }}
                                                        onClick={() => { setActiveModalTaskId(task.id); }}
                                                    >
                                                        {/* Navigation Controls */}
                                                        <div className="absolute top-4 right-4 flex gap-1 z-10">
                                                            {/* Backward Button (Hidden for Upcoming) */}
                                                            {task.status !== 'Upcoming' && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); moveTaskStatus(task.id, task.status, -1); }}
                                                                    className="p-1.5 rounded-full bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 transition-colors"
                                                                    title="Previous Status"
                                                                >
                                                                    <ArrowLeft className="w-4 h-4" style={{ color: theme.textSec.color }} />
                                                                </button>
                                                            )}
                                                            
                                                            {/* Forward Button (Hidden for Completed) */}
                                                            {task.status !== 'Completed' && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); moveTaskStatus(task.id, task.status, 1); }}
                                                                    className={`p-1.5 rounded-full transition-colors ${task.status === 'In Progress' ? 'bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30' : 'bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20'}`}
                                                                    title={task.status === 'In Progress' ? 'Finish Task' : 'Next Status'}
                                                                >
                                                                    {task.status === 'In Progress' ? (
                                                                        <Check className="w-4 h-4" />
                                                                    ) : (
                                                                        <ArrowRight className="w-4 h-4" style={{ color: theme.textSec.color }} />
                                                                    )}
                                                                </button>
                                                            )}
                                                        </div>

                                                        <div className="flex justify-between items-start mb-2 pr-20">
                                                            <div className={`text-[10px] font-bold px-2 py-1 rounded-lg uppercase tracking-wider mb-1 inline-block border ${task.priority === 'High' ? 'bg-red-500/10 text-red-500 border-red-500/20' : task.priority === 'Medium' ? 'bg-orange-500/10 text-orange-500 border-orange-500/20' : 'bg-blue-500/10 text-blue-500 border-blue-500/20'}`}>
                                                                {task.priority}
                                                            </div>
                                                            {task.deadline && (
                                                                <div className={`text-[10px] font-bold flex items-center gap-1 ${isOverdue ? 'text-red-500' : 'text-gray-400'}`}>
                                                                    <Clock className="w-3 h-3" /> {new Date(task.deadline).toLocaleDateString(undefined, {month:'short', day:'numeric'})}
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        <div className={`font-bold text-base mb-3 leading-snug line-clamp-2`} style={theme.textMain}>{task.text}</div>

                                                        {/* Revenue Badge on Card */}
                                                        {task.revenue > 0 && (
                                                            <div className="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-green-500/10 text-green-500 text-xs font-bold mb-3">
                                                                <DollarSign className="w-3 h-3" /> {formatCurrency(task.revenue)}
                                                            </div>
                                                        )}

                                                        <div className="flex items-center justify-between mt-auto">
                                                            <div className="flex items-center gap-2">
                                                                {subtaskCount > 0 && (
                                                                    <div className="flex items-center gap-1 text-xs font-bold" style={{ color: progress === 100 ? '#10b981' : theme.textSec.color }}>
                                                                        <CheckCircle2 className="w-3.5 h-3.5" /> {subtaskCompleted}/{subtaskCount}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className={`w-6 h-6 rounded-full flex items-center justify-center border opacity-0 group-hover:opacity-100 transition-opacity`} style={{ borderColor: theme.card.borderColor }}>
                                                                <Maximize2 className="w-3 h-3" style={theme.textSec} />
                                                            </div>
                                                        </div>
                                                        
                                                        {/* TAGS ON CARD - Modified to wrap and show all tags */}
                                                        {task.categories?.length > 0 && (
                                                            <div className="flex flex-wrap gap-1 mt-3">
                                                                {task.categories.map(cat => (
                                                                    <div key={cat} className="flex items-center gap-1 text-[10px] font-bold uppercase px-1.5 py-0.5 rounded border" style={{ borderColor: theme.card.borderColor, color: theme.textSec.color }}>
                                                                        <Tag className="w-3 h-3" /> {cat} 
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}

                                                        {subtaskCount > 0 && (
                                                            <div className="h-1 w-full bg-gray-200/50 dark:bg-gray-700/50 rounded-full mt-3 overflow-hidden">
                                                                <div className="h-full transition-all duration-500 rounded-full" style={{ width: `${progress}%`, backgroundColor: theme.accent }}></div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {colTasks.length === 0 && (
                                                <div className="h-32 border-2 border-dashed rounded-3xl flex flex-col gap-2 items-center justify-center text-sm font-bold opacity-30 select-none" style={{ borderColor: theme.isDark ? '#333' : '#ddd', color: theme.textSec.color }}>
                                                    <div className="p-3 rounded-full bg-gray-500/10"><Icon className="w-6 h-6" /></div>
                                                    No tasks
                                                </div>
                                            )}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    {/* Bottom Navigation for Mobile (Hidden if Music Bar is active) */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-black/80 backdrop-blur-md text-white px-4 py-2 rounded-full flex gap-4 shadow-2xl border border-white/10 md:hidden">
                    {COLUMNS.map((col, idx) => (
                        <button key={col.id} onClick={() => { scrollToColumn(idx); }} className={`p-2 rounded-full transition-all ${activeColId === col.id ? 'bg-white/20' : 'text-gray-400'}`} style={activeColId === col.id ? { color: theme.accent } : {}}>
                            <col.icon className="w-5 h-5" />
                        </button>
                    ))}
                    {/* Mobile Revenue Button */}
                    <button onClick={() => setShowRevenueModal(true)} className={`p-2 rounded-full transition-all text-green-500 bg-white/10`}>
                        <DollarSign className="w-5 h-5" />
                    </button>
                    </div>
                </div>
            </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
